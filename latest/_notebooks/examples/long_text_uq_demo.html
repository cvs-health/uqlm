
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" sizes="16x16" href="../../_static/images/favicon/favicon-16x16.png" type="image/png">
    <link rel="icon" sizes="32x32" href="../../_static/images/favicon/favicon-32x32.png" type="image/png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../_static/images/favicon/apple-touch-icon.png" type="image/png">
    <title>üéØ Long-Text Uncertainty Quantification &#8212; uqlm 0.5 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=662d8ef6" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=db78e746"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "displayMath": [["$$", "$$"], ["\\[", "\\]"]]}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_notebooks/examples/long_text_uq_demo';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://cvs-health.github.io/uqlm/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '0.5';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="üéØ Graph-Based Uncertainty Quantification (Long-Text)" href="long_text_graph_demo.html" />
    <link rel="prev" title="üéØ LLM-as-a-Judge" href="judges_demo.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/horizontal_logo.png" class="logo__image only-light" alt="uqlm 0.5 documentation - Home"/>
    <img src="../../_static/horizontal_logo_no_bg.png" class="logo__image only-dark pst-js-only" alt="uqlm 0.5 documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getstarted.html">
    Get Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../scorer_definitions/index.html">
    Scorer Definitions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api.html">
    API
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Example Notebooks
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../contribute.html">
    Contributor Guide
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../faqs.html">
    FAQs
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/cvs-health/uqlm" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getstarted.html">
    Get Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../scorer_definitions/index.html">
    Scorer Definitions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api.html">
    API
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Example Notebooks
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../contribute.html">
    Contributor Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../faqs.html">
    FAQs
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/cvs-health/uqlm" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="black_box_demo.html">üéØ Black-Box Uncertainty Quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="white_box_single_generation_demo.html">üéØ White-Box Uncertainty Quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="white_box_multi_generation_demo.html">üéØ White-Box Uncertainty Quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="ensemble_off_the_shelf_demo.html">üéØ BS Detector: Off-the-Shelf Ensemble for LLM Uncertainty</a></li>
<li class="toctree-l1"><a class="reference internal" href="ensemble_tuning_demo.html">üéØ Tunable Ensemble for LLM Uncertainty (Advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="judges_demo.html">üéØ LLM-as-a-Judge</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">üéØ Long-Text Uncertainty Quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="long_text_graph_demo.html">üéØ Graph-Based Uncertainty Quantification (Long-Text)</a></li>
<li class="toctree-l1"><a class="reference internal" href="long_text_qa_demo.html">üéØ Claim-QA Uncertainty Quantification (Long-Text)</a></li>
<li class="toctree-l1"><a class="reference internal" href="semantic_entropy_demo.html">üéØ Semantic Entropy</a></li>
<li class="toctree-l1"><a class="reference internal" href="semantic_density_demo.html">üéØ Semantic Density</a></li>
<li class="toctree-l1"><a class="reference internal" href="multimodal_demo.html">üéØ Multimodal Uncertainty Quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="score_calibration_demo.html">üéØ Confidence Score Calibration Demo</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Example Notebooks</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">üéØ Long-Text Uncertainty Quantification</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="üéØ-Long-Text-Uncertainty-Quantification">
<h1>üéØ Long-Text Uncertainty Quantification<a class="headerlink" href="#üéØ-Long-Text-Uncertainty-Quantification" title="Link to this heading">#</a></h1>
<div style="background-color: rgba(200, 200, 200, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(127, 127, 127, 0.2); max-width: 97.5%; overflow-wrap: break-word;"><p style="font-size: 16px; line-height: 1.6"><p>Long-Text Uncertainty Quantification (LUQ) is a long-form adaptation of black-box uncertainty quantification. This approach generates multiple responses to the same prompt, decomposes those responses into granular units (sentences or claims), and scores those units by measuring whether sampled responses entail each unit. This demo provides an illustration of how to use the LUQ methods with uqlm. The available scorers and papers from which they are adapted are below:</p>
</p><ul class="simple">
<li><p>Long-text Uncertainty Quantification (LUQ) (<a class="reference external" href="https://arxiv.org/abs/2403.20279">Zhang et al., 2024</a>)</p></li>
<li><p>LUQ-Atomic (<a class="reference external" href="https://arxiv.org/abs/2403.20279">Zhang et al., 2024</a>)</p></li>
<li><p>LUQ-pair (<a class="reference external" href="https://arxiv.org/abs/2403.20279">Zhang et al., 2024</a>)</p></li>
<li><p>Generalized LUQ-pair (<a class="reference external" href="https://arxiv.org/abs/2403.20279">Zhang et al., 2024</a>)</p></li>
</ul>
</div><section id="üìä-What-You'll-Do-in-This-Demo">
<h2>üìä What You‚Äôll Do in This Demo<a class="headerlink" href="#üìä-What-You'll-Do-in-This-Demo" title="Link to this heading">#</a></h2>
<div style="display: flex; margin-bottom: 15px; align-items: center"><div style="background-color: #34a853; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; margin-right: 15px; flex-shrink: 0"><p>1</p>
</div><div><p style="margin: 0; font-weight: bold"><p>Set up LLM and prompts.</p>
</p><p style="margin: 0; color: rgba(95, 99, 104, 0.8)"><p>Set up LLM instance and load example data prompts.</p>
</p></div></div><div style="display: flex; margin-bottom: 15px; align-items: center"><div style="background-color: #34a853; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; margin-right: 15px; flex-shrink: 0"><p>2</p>
</div><div><p style="margin: 0; font-weight: bold"><p>Generate LLM Responses and Confidence Scores</p>
</p><p style="margin: 0; color: rgba(95, 99, 104, 0.8)"><p>Generate responses and compute claim-level confidence scores using the LongTextUQ() class.</p>
</p></div></div><div style="display: flex; margin-bottom: 25px; align-items: center"><div style="background-color: #34a853; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; margin-right: 15px; flex-shrink: 0"><p>3</p>
</div><div><p style="margin: 0; font-weight: bold"><p>Evaluate Hallucination Detection Performance</p>
</p><p style="margin: 0; color: rgba(95, 99, 104, 0.8)"><p>Grade claims with <code class="docutils literal notranslate"><span class="pre">FactScoreGrader</span></code> class and evaluate claim-level hallucination detection.</p>
</p></div></div></section>
<section id="‚öñÔ∏è-Advantages-&amp;-Limitations">
<h2>‚öñÔ∏è Advantages &amp; Limitations<a class="headerlink" href="#‚öñÔ∏è-Advantages-&-Limitations" title="Link to this heading">#</a></h2>
<div style="display: flex; gap: 20px"><div style="flex: 1; background-color: rgba(0, 200, 0, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0, 200, 0, 0.2)"><h3 style="color: #2e8b57; margin-top: 0"><p>Pros</p>
</h3><ul style="margin-bottom: 0"><li><p>Universal Compatibility: Works with any LLM without requiring token probability access</p>
</li><li><p>Fine-Grained Scoring: Score at sentence or claim-level to localize likely hallucinations</p>
</li><li><p>Uncertainty-aware decoding: Improve factual precision by dropping high-uncertainty claims</p>
</li></ul></div><div style="flex: 1; background-color: rgba(200, 0, 0, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(200, 0, 0, 0.2)"><h3 style="color: #b22222; margin-top: 0"><p>Cons</p>
</h3><ul style="margin-bottom: 0"><li><p>Higher Cost: Requires multiple generations per prompt</p>
</li><li><p>Slower: Multiple generations and comparison calculations increase latency</p>
</li></ul></div></div><div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">uqlm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LongTextUQ</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uqlm.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_example_dataset</span><span class="p">,</span> <span class="n">display_response_refinement</span><span class="p">,</span> <span class="n">claims_dicts_to_lists</span><span class="p">,</span> <span class="n">plot_model_accuracies</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uqlm.longform</span><span class="w"> </span><span class="kn">import</span> <span class="n">FactScoreGrader</span>
</pre></div>
</div>
</div>
</section>
<section id="1.-Set-up-LLM-and-Prompts">
<h2>1. Set up LLM and Prompts<a class="headerlink" href="#1.-Set-up-LLM-and-Prompts" title="Link to this heading">#</a></h2>
<p>In this demo, we will illustrate this approach using the <a class="reference external" href="https://github.com/shmsw25/FActScore/tree/main/factscore">FactScore</a> longform QA dataset. To implement with your use case, simply <strong>replace the example prompts with your data</strong>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load example dataset (FactScore)</span>
<span class="n">factscore</span> <span class="o">=</span> <span class="n">load_example_dataset</span><span class="p">(</span><span class="s2">&quot;factscore&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)[[</span><span class="s2">&quot;factscore_prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;wikipedia_text&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;factscore_prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;prompt&quot;</span><span class="p">})</span>
<span class="n">factscore</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loading dataset - factscore...
Processing dataset...
Dataset ready!
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prompt</th>
      <th>wikipedia_text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Tell me a bio of Suthida.\n</td>
      <td>Suthida Bajrasudhabimalalakshana (Thai: ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Tell me a bio of Miguel √Ångel F√©lix Gallardo.\n</td>
      <td>Miguel √Ångel F√©lix Gallardo (born January 8, 1...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Tell me a bio of Iggy Azalea.\n</td>
      <td>Amethyst Amelia Kelly (born 7 June 1990), know...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Tell me a bio of Fernando da Costa Novaes.\n</td>
      <td>Fernando da Costa Novaes (April 6, 1927 ‚Äì Marc...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Tell me a bio of Jan Zamoyski.\n</td>
      <td>Jan Sariusz Zamoyski (Latin: Ioannes Zamoyski ...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>In this example, we use <code class="docutils literal notranslate"><span class="pre">AzureChatOpenAI</span></code> to instantiate our LLM, but any <a class="reference external" href="https://js.langchain.com/docs/integrations/chat/">LangChain Chat Model</a> may be used. Be sure to <strong>replace with your LLM of choice.</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import sys</span>
<span class="c1"># !{sys.executable} -m pip install langchain-openai</span>

<span class="c1">## User to populate .env file with API credentials</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span><span class="p">,</span> <span class="n">find_dotenv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">AzureChatOpenAI</span>

<span class="n">load_dotenv</span><span class="p">(</span><span class="n">find_dotenv</span><span class="p">())</span>
<span class="n">llm</span> <span class="o">=</span> <span class="n">AzureChatOpenAI</span><span class="p">(</span>
    <span class="n">deployment_name</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
    <span class="n">openai_api_type</span><span class="o">=</span><span class="s2">&quot;azure&quot;</span><span class="p">,</span>
    <span class="n">openai_api_version</span><span class="o">=</span><span class="s2">&quot;2024-12-01-preview&quot;</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># User to set temperature</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="2.-Generate-LLM-Responses-and-Claim/Sentence-Level-Confidence-Scores">
<h2>2. Generate LLM Responses and Claim/Sentence-Level Confidence Scores<a class="headerlink" href="#2.-Generate-LLM-Responses-and-Claim/Sentence-Level-Confidence-Scores" title="Link to this heading">#</a></h2>
<section id="LongTextUQ()---Generate-long-text-LLM-responses,-decompose-into-claims-or-sentences,-and-measure-entailment-among-sampled-responses.">
<h3><code class="docutils literal notranslate"><span class="pre">LongTextUQ()</span></code> - Generate long-text LLM responses, decompose into claims or sentences, and measure entailment among sampled responses.<a class="headerlink" href="#LongTextUQ()---Generate-long-text-LLM-responses,-decompose-into-claims-or-sentences,-and-measure-entailment-among-sampled-responses." title="Link to this heading">#</a></h3>
<p><img alt="Sample Image" src="https://raw.githubusercontent.com/cvs-health/uqlm/develop/assets/images/uad_graphic.png" /></p>
<section id="üìã-Class-Attributes">
<h4>üìã Class Attributes<a class="headerlink" href="#üìã-Class-Attributes" title="Link to this heading">#</a></h4>
<table style="border-collapse: collapse; width: 100%; border: 1px solid rgba(127, 127, 127, 0.2);"><tr><th style="background-color: rgba(200, 200, 200, 0.2); width: 20%; padding: 8px; text-align: left; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Parameter</p>
</th><th style="background-color: rgba(200, 200, 200, 0.2); width: 25%; padding: 8px; text-align: left; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Type &amp; Default</p>
</th><th style="background-color: rgba(200, 200, 200, 0.2); width: 55%; padding: 8px; text-align: left; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Description</p>
</th></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>llm</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>BaseChatModeldefault=None</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>A langchain llm <code class="docutils literal notranslate"><span class="pre">BaseChatModel</span></code>. User is responsible for specifying temperature and other relevant parameters to the constructor of the provided <code class="docutils literal notranslate"><span class="pre">llm</span></code> object.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>granularity</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>strdefault=‚Äùclaim‚Äù</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies whether to decompose and score at claim or sentence level granularity. Must be either ‚Äúclaim‚Äù or ‚Äúsentence‚Äù.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>mode</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>strdefault=‚Äùunit_response‚Äù</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies whether to implement unit-response (LUQ-style) scoring or matched-unit (LUQ-pair-style) scoring. Must be either ‚Äúunit_response‚Äù (recommended) or ‚Äúmatched_unit‚Äù.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>scorers</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>List[str]default=None</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies which black box (consistency) scorers to include. subset of {‚Äúentailment‚Äù, ‚Äúnoncontradiction‚Äù, ‚Äúcontrasted_entailment‚Äù, ‚Äúbert_score‚Äù, ‚Äúcosine_sim‚Äù}. If None, defaults to [‚Äúentailment‚Äù].</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>aggregation</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>strdefault=‚Äùmean‚Äù</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies how to aggregate claim/sentence-level scores to response-level scores. Must be one of ‚Äòmin‚Äô or ‚Äòmean‚Äô.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>response_refinement</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>booldefault=False</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies whether to refine responses with uncertainty-aware decoding. This approach removes claims with confidence scores below the response_refinement_threshold and uses the claim_decomposition_llm to reconstruct the response from the retained claims. For more details, refer to Jiang et al., 2024: <a class="reference external" href="https://arxiv.org/abs/2410.20783">https://arxiv.org/abs/2410.20783</a></p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>claim_filtering_scorer</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Optional[str]default=None</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies which scorer to use to filter claims if response_refinement is True. If not provided, defaults to the first element of self.scorers.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>claim_decomposition_llm</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>BaseChatModeldefault=None</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>A langchain llm <code class="docutils literal notranslate"><span class="pre">BaseChatModel</span></code> to be used for decomposing responses into individual claims. Also used for claim refinement. If granularity=‚Äùclaim‚Äù and claim_decomposition_llm is None, the provided <code class="docutils literal notranslate"><span class="pre">llm</span></code> will be used for claim decomposition.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>device</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>str or torch.devicedefault=None</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies the device that NLI model use for prediction. If None, detects and returns the best available PyTorch device. Prioritizes CUDA (NVIDIA GPU), then MPS (macOS), then CPU.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>system_prompt</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>str or Nonedefault=‚ÄùYou are a helpful assistant.‚Äù</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Optional argument for user to provide custom system prompt for the LLM.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>max_calls_per_min</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>intdefault=None</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies how many API calls to make per minute to avoid rate limit errors. By default, no limit is specified.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>use_n_param</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>booldefault=False</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies whether to use n parameter for BaseChatModel. Not compatible with all BaseChatModel classes. If used, it speeds up the generation process substantially when num_responses is large.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>sampling_temperature</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>floatdefault=1</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>The ‚Äòtemperature‚Äô parameter for LLM to use when generating sampled LLM responses. Must be greater than 0.</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>nli_model_name</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>strdefault=‚Äùmicrosoft/deberta-large-mnli‚Äù</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies which NLI model to use. Must be acceptable input to AutoTokenizer.from_pretrained() and AutoModelForSequenceClassification.from_pretrained().</p>
</td></tr><tr><td style="font-weight: bold; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>max_length</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>intdefault=2000</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Specifies the maximum allowed string length for LLM responses for NLI computation. Responses longer than this value will be truncated in NLI computations to avoid OutOfMemoryError.</p>
</td></tr></table></section>
<section id="üîç-Parameter-Groups">
<h4>üîç Parameter Groups<a class="headerlink" href="#üîç-Parameter-Groups" title="Link to this heading">#</a></h4>
<div style="display: flex; gap: 20px; margin-bottom: 20px"><div style="flex: 1; padding: 10px; background-color: rgba(0, 100, 200, 0.1); border-radius: 5px; border: 1px solid rgba(0, 100, 200, 0.2);"><p style="font-weight: bold"><p>üß† LLM-Specific</p>
</p><ul><li><p>llm</p>
</li><li><p>system_prompt</p>
</li><li><p>sampling_temperature</p>
</li></ul></div><div style="flex: 1; padding: 10px; background-color: rgba(0, 200, 0, 0.1); border-radius: 5px; border: 1px solid rgba(0, 200, 0, 0.2);"><p style="font-weight: bold"><p>üìä Confidence Scores</p>
</p><ul><li><p>granularity</p>
</li><li><p>scorers</p>
</li><li><p>mode</p>
</li><li><p>aggregation</p>
</li><li><p>response_refinement</p>
</li><li><p>response_refinement_threshold</p>
</li></ul></div><div style="flex: 1; padding: 10px; background-color: rgba(200, 150, 0, 0.1); border-radius: 5px; border: 1px solid rgba(200, 150, 0, 0.2);"><p style="font-weight: bold"><p>üñ•Ô∏è Hardware</p>
</p><ul><li><p>device</p>
</li></ul></div><div style="flex: 1; padding: 10px; background-color: rgba(200, 0, 200, 0.1); border-radius: 5px; border: 1px solid rgba(200, 0, 200, 0.2);"><p style="font-weight: bold"><p>‚ö° Performance</p>
</p><ul><li><p>max_calls_per_min</p>
</li><li><p>use_n_param</p>
</li></ul></div></div><p>```</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">luq</span> <span class="o">=</span> <span class="n">LongTextUQ</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">granularity</span><span class="o">=</span><span class="s2">&quot;claim&quot;</span><span class="p">,</span>  <span class="c1"># &#39;claim&#39; recommended</span>
    <span class="n">aggregation</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>  <span class="c1"># switch to &#39;min&#39; for more conservative scoring</span>
    <span class="n">response_refinement</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># whether to filter out low-confidence claims</span>
    <span class="n">max_calls_per_min</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
    <span class="n">max_length</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
claim_filtering_scorer is not specified for response_refinement. Defaulting to entailment.
</pre></div></div>
</div>
</section>
</section>
<section id="üîÑ-Class-Methods">
<h3>üîÑ Class Methods<a class="headerlink" href="#üîÑ-Class-Methods" title="Link to this heading">#</a></h3>
<table style="border-collapse: collapse; width: 100%; border: 1px solid rgba(127, 127, 127, 0.2);"><tr><th style="background-color: rgba(200, 200, 200, 0.2); width: 25%; padding: 8px; text-align: left; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Method</p>
</th><th style="background-color: rgba(200, 200, 200, 0.2); width: 75%; padding: 8px; text-align: left; border: 1px solid rgba(127, 127, 127, 0.2);"><p>Description &amp; Parameters</p>
</th></tr><tr><td style="font-weight: bold; vertical-align: top; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>BlackBoxUQ.generate_and_score</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p><p>Generate LLM responses, sampled LLM (candidate) responses, and compute confidence scores for the provided prompts.</p>
</p><p><p>Parameters:</p>
</p><ul><li><p>prompts - (List[str] or List[List[BaseMessage]]) A list of input prompts for the model.</p>
</li><li><p>num_responses - (int, default=5) The number of sampled responses used to compute consistency.</p>
</li><li><p>response_refinement_threshold - (float, default=1/3) Threshold for uncertainty-aware filtering. Claims with confidence scores below this threshold are dropped from the refined response. Only used if response_refinement is True.</p>
</li><li><p>show_progress_bars - (bool, default=True) If True, displays a progress bar while generating and scoring responses.</p>
</li></ul><p><p>Returns: UQResult containing data (prompts, responses, sampled responses, and confidence scores) and metadata</p>
</p><div style="background-color: rgba(0, 200, 0, 0.1); padding: 8px; border-radius: 3px; margin-top: 10px; border: 1px solid rgba(0, 200, 0, 0.2); margin-right: 5px; box-sizing: border-box; width: 100%;"><p>üí° Best For: Complete end-to-end uncertainty quantification when starting with prompts.</p>
</div></td></tr><tr><td style="font-weight: bold; vertical-align: top; padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p>BlackBoxUQ.score</p>
</td><td style="padding: 8px; border: 1px solid rgba(127, 127, 127, 0.2);"><p><p>Compute confidence scores on provided LLM responses. Should only be used if responses and sampled responses are already generated.</p>
</p><p><p>Parameters:</p>
</p><ul><li><p>responses - (List[str]) A list of LLM responses for the prompts.</p>
</li><li><p>sampled_responses - (List[List[str]]) A list of lists of sampled LLM responses for each prompt. Used to compute consistency scores by comparing to the corresponding response from responses.</p>
</li><li><p>response_refinement_threshold - (float, default=1/3) Threshold for uncertainty-aware filtering. Claims with confidence scores below this threshold are dropped from the refined response. Only used if response_refinement is True.</p>
</li><li><p>show_progress_bars - (bool, default=True) If True, displays a progress bar while scoring responses.</p>
</li></ul><p><p>Returns: UQResult containing data (responses, sampled responses, and confidence scores) and metadata</p>
</p><div style="background-color: rgba(0, 200, 0, 0.1); padding: 8px; border-radius: 3px; margin-top: 10px; border: 1px solid rgba(0, 200, 0, 0.2); margin-right: 5px; box-sizing: border-box; width: 100%;"><p>üí° Best For: Computing uncertainty scores when responses are already generated elsewhere.</p>
</div></td></tr></table><div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">luq</span><span class="o">.</span><span class="n">generate_and_score</span><span class="p">(</span>
    <span class="n">prompts</span><span class="o">=</span><span class="n">factscore</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># choose num_responses based on cost and latency requirements (higher means better hallucination detection but more cost and latency)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "35873441961448f7839f5577cd288abf", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_df</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prompt</th>
      <th>response</th>
      <th>sampled_responses</th>
      <th>entailment</th>
      <th>claims_data</th>
      <th>refined_response</th>
      <th>refined_entailment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Tell me a bio of Suthida.\n</td>
      <td>Suthida Bajrasudhabimalalakshana, born on June...</td>
      <td>[Suthida Bajrasudhabimalalakshana, commonly kn...</td>
      <td>0.378289</td>
      <td>[{'claim': 'Suthida Bajrasudhabimalalakshana w...</td>
      <td>Suthida Bajrasudhabimalalakshana, born on June...</td>
      <td>0.786631</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Tell me a bio of Miguel √Ångel F√©lix Gallardo.\n</td>
      <td>Miguel √Ångel F√©lix Gallardo, often referred to...</td>
      <td>[Miguel √Ångel F√©lix Gallardo, often referred t...</td>
      <td>0.472164</td>
      <td>[{'claim': 'Miguel √Ångel F√©lix Gallardo is oft...</td>
      <td>Miguel √Ångel F√©lix Gallardo, often referred to...</td>
      <td>0.654868</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Tell me a bio of Iggy Azalea.\n</td>
      <td>Iggy Azalea, born Amethyst Amelia Kelly on Jun...</td>
      <td>[Iggy Azalea, born Amethyst Amelia Kelly on Ju...</td>
      <td>0.468483</td>
      <td>[{'claim': 'Iggy Azalea was born Amethyst Amel...</td>
      <td>Iggy Azalea, born Amethyst Amelia Kelly on Jun...</td>
      <td>0.650532</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Tell me a bio of Fernando da Costa Novaes.\n</td>
      <td>Fernando da Costa Novaes was a prominent Brazi...</td>
      <td>[Fernando da Costa Novaes was a Brazilian orni...</td>
      <td>0.494438</td>
      <td>[{'claim': 'Fernando da Costa Novaes was a pro...</td>
      <td>Fernando da Costa Novaes was a highly respecte...</td>
      <td>0.705326</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Tell me a bio of Jan Zamoyski.\n</td>
      <td>Jan Zamoyski (1542‚Äì1605) was a prominent Polis...</td>
      <td>[Jan Zamoyski (1542‚Äì1605) was a prominent Poli...</td>
      <td>0.573752</td>
      <td>[{'claim': 'Jan Zamoyski was a Polish nobleman...</td>
      <td>Jan Zamoyski, born in 1542 and deceased in 160...</td>
      <td>0.733766</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<section id="Response-refinement">
<h4>Response refinement<a class="headerlink" href="#Response-refinement" title="Link to this heading">#</a></h4>
<p>Response refinement works by dropping claims with confidence scores (specified with <code class="docutils literal notranslate"><span class="pre">claim_filtering_scorer</span></code>) below a specified threshold (specified with <code class="docutils literal notranslate"><span class="pre">response_refinement_threshold</span></code>) and reconstructing the response from the retained claims.</p>
<p><img alt="Sample Image" src="https://raw.githubusercontent.com/cvs-health/uqlm/develop/assets/images/uad_graphic.png" /></p>
<p>To illustrate how the response refinement operates, let‚Äôs view an example. We first view the fine-grained claim-level data, including the claims in the original response, the claim-level confidence scores, and whether each claim was removed during the response refinement process.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># View fine-grained claim data for the first response</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">claims_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;claim&#39;: &#39;Suthida Bajrasudhabimalalakshana was born on June 3, 1978.&#39;,
  &#39;removed&#39;: False,
  &#39;entailment&#39;: 0.9548099517822266},
 {&#39;claim&#39;: &#39;Suthida Bajrasudhabimalalakshana is the Queen of Thailand.&#39;,
  &#39;removed&#39;: False,
  &#39;entailment&#39;: 0.909833800792694},
 {&#39;claim&#39;: &#39;Suthida Bajrasudhabimalalakshana became queen following her marriage to King Maha Vajiralongkorn on May 1, 2019.&#39;,
  &#39;removed&#39;: False,
  &#39;entailment&#39;: 0.9487567067146301},
 {&#39;claim&#39;: &#39;Suthida Bajrasudhabimalalakshana was known for her service in the Thai military.&#39;,
  &#39;removed&#39;: False,
  &#39;entailment&#39;: 0.6286507695913315},
 {&#39;claim&#39;: &#39;Suthida Bajrasudhabimalalakshana was known for her service in royal security.&#39;,
  &#39;removed&#39;: False,
  &#39;entailment&#39;: 0.4196613132953644},
 {&#39;claim&#39;: &#39;Suthida Bajrasudhabimalalakshana joined the Thai military.&#39;,
  &#39;removed&#39;: False,
  &#39;entailment&#39;: 0.8370264410972595},
 {&#39;claim&#39;: &#39;Suthida Bajrasudhabimalalakshana rose to the rank of General in the Thai military.&#39;,
  &#39;removed&#39;: False,
  &#39;entailment&#39;: 0.9057967782020568},
 {&#39;claim&#39;: &#34;Suthida Bajrasudhabimalalakshana&#39;s notable role was as the Deputy Commander of the King‚Äôs Own Bodyguard Battalion.&#34;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.05324118752032518},
 {&#39;claim&#39;: &#39;Suthida Bajrasudhabimalalakshana was appointed as the Commander of the Special Operations Unit of the King‚Äôs Guard in 2013.&#39;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.011244434397667646},
 {&#39;claim&#39;: &#39;Suthida Bajrasudhabimalalakshana was made the Commander of the Royal Thai Aide-de-Camp Department.&#39;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.0545421352609992},
 {&#39;claim&#39;: &#34;Suthida Bajrasudhabimalalakshana&#39;s service to the royal family began during Vajiralongkorn&#39;s time as Crown Prince.&#34;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.17842963952571153},
 {&#39;claim&#39;: &#39;Suthida Bajrasudhabimalalakshana was appointed as a General in the Royal Thai Army in December 2016.&#39;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.20516443867236375},
 {&#39;claim&#39;: &#39;Vajiralongkorn ascended to the throne shortly before December 2016.&#39;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.0191670348867774},
 {&#39;claim&#39;: &#34;Queen Suthida&#39;s royal name is Her Majesty Queen Suthida Bajrasudhabimalalakshana.&#34;,
  &#39;removed&#39;: False,
  &#39;entailment&#39;: 0.7257313817739487},
 {&#39;claim&#39;: &#34;Queen Suthida&#39;s royal name was bestowed upon her after marriage.&#34;,
  &#39;removed&#39;: False,
  &#39;entailment&#39;: 0.7494151771068573},
 {&#39;claim&#39;: &#34;The marriage and Queen Suthida&#39;s subsequent coronation were part of the elaborate royal ceremonies.&#34;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.04578750394284725},
 {&#39;claim&#39;: &#34;The elaborate royal ceremonies solidified Queen Suthida&#39;s position as the consort of the reigning monarch.&#34;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.09274227768182755},
 {&#39;claim&#39;: &#39;Queen Suthida is known for her dignity.&#39;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.16823009476065637},
 {&#39;claim&#39;: &#39;Queen Suthida is known for her dedication to her roles in royal duties.&#39;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.22584835886955262},
 {&#39;claim&#39;: &#39;Queen Suthida is known for her dedication to her previous military service.&#39;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.04379986636340618},
 {&#39;claim&#39;: &#34;Queen Suthida&#39;s work and public engagements often highlight charitable activities in Thailand.&#34;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.05280689503997564},
 {&#39;claim&#39;: &#34;Queen Suthida&#39;s work and public engagements often support various social causes within Thailand.&#34;,
  &#39;removed&#39;: True,
  &#39;entailment&#39;: 0.09166227281093597}]
</pre></div></div>
</div>
<p>We can then visualize the response refinement process for this response using the <code class="docutils literal notranslate"><span class="pre">display_response_refinement</span></code>. This shows the original response vs. the refined response and identifies which claims were removed due to low confidence.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_response_refinement</span><span class="p">(</span><span class="n">original_text</span><span class="o">=</span><span class="n">result_df</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">claims_data</span><span class="o">=</span><span class="n">result_df</span><span class="o">.</span><span class="n">claims_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">refined_text</span><span class="o">=</span><span class="n">result_df</span><span class="o">.</span><span class="n">refined_response</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                            <span style="color: #000000; text-decoration-color: #000000; font-weight: bold">Response Refinement Example</span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #808000; text-decoration-color: #808000">‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ </span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">Original Response</span><span style="color: #808000; text-decoration-color: #808000"> ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Suthida Bajrasudhabimalalakshana, born on June 3, 1978, is the Queen of Thailand. She became queen following    <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> her marriage to King Maha Vajiralongkorn (Rama X) on May 1, 2019.                                               <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>                                                                                                                 <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Before becoming queen, Suthida was known for her service in the Thai military and royal security. She joined    <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> the Thai military, where she eventually rose to the rank of General. Her notable role was as the Deputy         <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Commander of the King‚Äôs Own Bodyguard Battalion. Suthida was also appointed as the Commander of the Special     <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Operations Unit of the King‚Äôs Guard in 2013, and later, she was made the Commander of the Royal Thai            <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Aide-de-Camp Department.                                                                                        <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>                                                                                                                 <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Her service to the royal family and her close association with King Vajiralongkorn began during his time as     <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Crown Prince. Suthida was appointed as a General in the Royal Thai Army in December 2016, shortly after         <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Vajiralongkorn ascended to the throne.                                                                          <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>                                                                                                                 <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Queen Suthida's royal name, bestowed upon her after marriage, is Her Majesty Queen Suthida                      <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Bajrasudhabimalalakshana. The marriage and her subsequent coronation as queen were part of the elaborate royal  <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> ceremonies that solidified her position as the consort of the reigning monarch.                                 <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>                                                                                                                 <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> Queen Suthida is known for her dignity and dedication to her roles both in royal duties and her previous        <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> military service. Her work and public engagements often highlight charitable activities and support for various <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚îÇ</span> social causes within Thailand.                                                                                  <span style="color: #808000; text-decoration-color: #808000">‚îÇ</span>
<span style="color: #808000; text-decoration-color: #808000">‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ</span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Low-Confidence Claims to be Removed</span><span style="color: #800000; text-decoration-color: #800000"> ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Suthida Bajrasudhabimalalakshana's notable role was as the Deputy Commander of the King‚Äôs Own Bodyguard       <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> Battalion.                                                                                                      <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Suthida Bajrasudhabimalalakshana was appointed as the Commander of the Special Operations Unit of the King‚Äôs  <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> Guard in 2013.                                                                                                  <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Suthida Bajrasudhabimalalakshana was made the Commander of the Royal Thai Aide-de-Camp Department.            <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Suthida Bajrasudhabimalalakshana's service to the royal family began during Vajiralongkorn's time as Crown    <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> Prince.                                                                                                         <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Suthida Bajrasudhabimalalakshana was appointed as a General in the Royal Thai Army in December 2016.          <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Vajiralongkorn ascended to the throne shortly before December 2016.                                           <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ The marriage and Queen Suthida's subsequent coronation were part of the elaborate royal ceremonies.           <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ The elaborate royal ceremonies solidified Queen Suthida's position as the consort of the reigning monarch.    <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Queen Suthida is known for her dignity.                                                                       <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Queen Suthida is known for her dedication to her roles in royal duties.                                       <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Queen Suthida is known for her dedication to her previous military service.                                   <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Queen Suthida's work and public engagements often highlight charitable activities in Thailand.                <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚îÇ</span> ‚Ä¢ Queen Suthida's work and public engagements often support various social causes within Thailand.              <span style="color: #800000; text-decoration-color: #800000">‚îÇ</span>
<span style="color: #800000; text-decoration-color: #800000">‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ</span>
</pre></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008000; text-decoration-color: #008000">‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ </span><span style="color: #008000; text-decoration-color: #008000; font-weight: bold">Refined Response</span><span style="color: #008000; text-decoration-color: #008000"> ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ</span>
<span style="color: #008000; text-decoration-color: #008000">‚îÇ</span> Suthida Bajrasudhabimalalakshana, born on June 3, 1978, is the Queen of Thailand. She became queen following    <span style="color: #008000; text-decoration-color: #008000">‚îÇ</span>
<span style="color: #008000; text-decoration-color: #008000">‚îÇ</span> her marriage to King Maha Vajiralongkorn on May 1, 2019, and upon marriage, she was bestowed with the royal     <span style="color: #008000; text-decoration-color: #008000">‚îÇ</span>
<span style="color: #008000; text-decoration-color: #008000">‚îÇ</span> name Her Majesty Queen Suthida Bajrasudhabimalalakshana. Before her ascension to the throne, Queen Suthida was  <span style="color: #008000; text-decoration-color: #008000">‚îÇ</span>
<span style="color: #008000; text-decoration-color: #008000">‚îÇ</span> recognized for her dedicated service in the Thai military, where she rose to the rank of General, and in royal  <span style="color: #008000; text-decoration-color: #008000">‚îÇ</span>
<span style="color: #008000; text-decoration-color: #008000">‚îÇ</span> security. Her military career and commitment to royal security played a significant role in her rise to         <span style="color: #008000; text-decoration-color: #008000">‚îÇ</span>
<span style="color: #008000; text-decoration-color: #008000">‚îÇ</span> prominence, ultimately leading to her role as queen.                                                            <span style="color: #008000; text-decoration-color: #008000">‚îÇ</span>
<span style="color: #008000; text-decoration-color: #008000">‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="3.-Evaluate-Hallucination-Detection-Performance">
<h2>3. Evaluate Hallucination Detection Performance<a class="headerlink" href="#3.-Evaluate-Hallucination-Detection-Performance" title="Link to this heading">#</a></h2>
<p>To evaluate hallucination detection performance, we ‚Äògrade‚Äô the atomic claims in the responses against an answer key. Here, we use UQLM‚Äôs out-of-the-box <code class="docutils literal notranslate"><span class="pre">FactScoreGrader</span></code>, which can be used with <a class="reference external" href="https://js.langchain.com/docs/integrations/chat/">LangChain Chat Model</a>. <strong>If you are using your own prompts/questions, be sure to update the grading method accordingly</strong>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up the LLM grader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_google_vertexai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatVertexAI</span>

<span class="n">gemini_flash</span> <span class="o">=</span> <span class="n">ChatVertexAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gemini-2.5-flash&quot;</span><span class="p">)</span>
<span class="n">grader</span> <span class="o">=</span> <span class="n">FactScoreGrader</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="n">gemini_flash</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Before grading, we need to have claims formatted in list of lists where each interior list corresponds to a generated response.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert claims to list of lists</span>
<span class="n">claims_data_lists</span> <span class="o">=</span> <span class="n">claims_dicts_to_lists</span><span class="p">(</span><span class="n">result_df</span><span class="o">.</span><span class="n">claims_data</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># grade original responses against the answer key using the grader</span>
<span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;claim_grades&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">grader</span><span class="o">.</span><span class="n">grade_claims</span><span class="p">(</span><span class="n">claim_sets</span><span class="o">=</span><span class="n">claims_data_lists</span><span class="p">[</span><span class="s2">&quot;claim&quot;</span><span class="p">],</span> <span class="n">answers</span><span class="o">=</span><span class="n">factscore</span><span class="p">[</span><span class="s2">&quot;wikipedia_text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
<span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;answer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">factscore</span><span class="p">[</span><span class="s2">&quot;wikipedia_text&quot;</span><span class="p">]</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prompt</th>
      <th>response</th>
      <th>sampled_responses</th>
      <th>entailment</th>
      <th>claims_data</th>
      <th>refined_response</th>
      <th>refined_entailment</th>
      <th>claim_grades</th>
      <th>answer</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Tell me a bio of Suthida.\n</td>
      <td>Suthida Bajrasudhabimalalakshana, born on June...</td>
      <td>[Suthida Bajrasudhabimalalakshana, commonly kn...</td>
      <td>0.378289</td>
      <td>[{'claim': 'Suthida Bajrasudhabimalalakshana w...</td>
      <td>Suthida Bajrasudhabimalalakshana, born on June...</td>
      <td>0.786631</td>
      <td>[True, True, False, True, True, True, True, Fa...</td>
      <td>Suthida Bajrasudhabimalalakshana (Thai: ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Tell me a bio of Miguel √Ångel F√©lix Gallardo.\n</td>
      <td>Miguel √Ångel F√©lix Gallardo, often referred to...</td>
      <td>[Miguel √Ångel F√©lix Gallardo, often referred t...</td>
      <td>0.472164</td>
      <td>[{'claim': 'Miguel √Ångel F√©lix Gallardo is oft...</td>
      <td>Miguel √Ångel F√©lix Gallardo, often referred to...</td>
      <td>0.654868</td>
      <td>[True, True, True, True, False, True, True, Tr...</td>
      <td>Miguel √Ångel F√©lix Gallardo (born January 8, 1...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Tell me a bio of Iggy Azalea.\n</td>
      <td>Iggy Azalea, born Amethyst Amelia Kelly on Jun...</td>
      <td>[Iggy Azalea, born Amethyst Amelia Kelly on Ju...</td>
      <td>0.468483</td>
      <td>[{'claim': 'Iggy Azalea was born Amethyst Amel...</td>
      <td>Iggy Azalea, born Amethyst Amelia Kelly on Jun...</td>
      <td>0.650532</td>
      <td>[True, True, True, True, False, True, True, Fa...</td>
      <td>Amethyst Amelia Kelly (born 7 June 1990), know...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Tell me a bio of Fernando da Costa Novaes.\n</td>
      <td>Fernando da Costa Novaes was a prominent Brazi...</td>
      <td>[Fernando da Costa Novaes was a Brazilian orni...</td>
      <td>0.494438</td>
      <td>[{'claim': 'Fernando da Costa Novaes was a pro...</td>
      <td>Fernando da Costa Novaes was a highly respecte...</td>
      <td>0.705326</td>
      <td>[True, True, True, True, False, True, True, Tr...</td>
      <td>Fernando da Costa Novaes (April 6, 1927 ‚Äì Marc...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Tell me a bio of Jan Zamoyski.\n</td>
      <td>Jan Zamoyski (1542‚Äì1605) was a prominent Polis...</td>
      <td>[Jan Zamoyski (1542‚Äì1605) was a prominent Poli...</td>
      <td>0.573752</td>
      <td>[{'claim': 'Jan Zamoyski was a Polish nobleman...</td>
      <td>Jan Zamoyski, born in 1542 and deceased in 160...</td>
      <td>0.733766</td>
      <td>[True, True, True, True, True, True, True, Tru...</td>
      <td>Jan Sariusz Zamoyski (Latin: Ioannes Zamoyski ...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_claim_scores</span><span class="p">,</span> <span class="n">all_claim_grades</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">)):</span>
    <span class="n">all_claim_scores</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">claims_data_lists</span><span class="p">[</span><span class="s2">&quot;entailment&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">all_claim_grades</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;claim_grades&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Baseline LLM accuracy: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_claim_grades</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Baseline LLM accuracy: 0.6737967914438503
</pre></div></div>
</div>
<p>To evaluate fine-grained hallucination detection performance, we compute AUROC of claim-level hallucination detection. Below, we plot the ROC curve and report these results.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">roc_auc_score</span>

<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">all_claim_grades</span><span class="p">,</span> <span class="n">y_score</span><span class="o">=</span><span class="n">all_claim_scores</span><span class="p">)</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">all_claim_grades</span><span class="p">,</span> <span class="n">y_score</span><span class="o">=</span><span class="n">all_claim_scores</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ROC curve (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;navy&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;False Positive Rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;True Positive Rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Receiver Operating Characteristic (ROC) Curve&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/_notebooks_examples_long_text_uq_demo_29_0.png" src="../../_images/_notebooks_examples_long_text_uq_demo_29_0.png" />
</div>
</div>
<p>Lastly, we evaluate the gains from uncertainty-aware decoding (UAD) by measuring the factual precision over claims at various filtering thresholds.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_model_accuracies</span><span class="p">(</span><span class="n">scores</span><span class="o">=</span><span class="n">all_claim_scores</span><span class="p">,</span> <span class="n">correct_indicators</span><span class="o">=</span><span class="n">all_claim_grades</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;LLM Accuracy by Claim Confidence Threshold&quot;</span><span class="p">,</span> <span class="n">display_percentage</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/_notebooks_examples_long_text_uq_demo_32_0.png" src="../../_images/_notebooks_examples_long_text_uq_demo_32_0.png" />
</div>
</div>
<p>Since, we have selected a threshold of 1/3, we can measure LLM accuracy with and without UAD.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thresh</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span>
<span class="n">filtered_grades</span><span class="p">,</span> <span class="n">filtered_scores</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">grade</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_claim_grades</span><span class="p">,</span> <span class="n">all_claim_scores</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">:</span>
        <span class="n">filtered_grades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grade</span><span class="p">)</span>
        <span class="n">filtered_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Baseline LLM factual precision: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_claim_grades</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UAD-Improved LLM factual precision: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">filtered_grades</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Baseline LLM factual precision: 0.6737967914438503
UAD-Improved LLM factual precision: 0.7665952890792291
</pre></div></div>
</div>
</section>
<section id="4.-Scorer-Definitions">
<h2>4. Scorer Definitions<a class="headerlink" href="#4.-Scorer-Definitions" title="Link to this heading">#</a></h2>
<p>Long-form uncertainty quantification implements a three-stage pipeline after response generation:</p>
<ol class="arabic simple">
<li><p>Response Decomposition: The response <span class="math notranslate nohighlight">\(y\)</span> is decomposed into units (claims or sentences), where a unit as denoted as <span class="math notranslate nohighlight">\(s\)</span>.</p></li>
<li><p>Unit-Level Confidence Scoring: Confidence scores are computed using function <span class="math notranslate nohighlight">\(c_g(s;\cdot) \in [0, 1]\)</span>. Higher scores indicate greater likelihood of factual correctness. Units with scores below threshold <span class="math notranslate nohighlight">\(\tau\)</span> are flagged as potential hallucinations.</p></li>
<li><p>Response-Level Aggregation: Unit scores are combined to provide an overall response confidence.</p></li>
</ol>
<p>The Long-text UQ (LUQ) approach demonstrated here is adapted from <a class="reference external" href="https://arxiv.org/abs/2403.20279">Zhang et al., 2024</a>. Similar to standard black-box UQ, this approach requires generating a original response and sampled candidate responses to the same prompt. The original response is then decomposed into units (claims or sentences). Unit-level confidence scores are then obtained by averaging entailment probabilities across candidate responses:</p>
<div class="math notranslate nohighlight">
\[c_g(s; \mathbf{y}_{\text{cand}}) = \frac{1}{m} \sum_{j=1}^m P(\text{entail}|y_j, s)\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{y}^{(s)}_{\text{cand}} = {y_1^{(s)}, ..., y_m^{(s)}}\)</span> are <span class="math notranslate nohighlight">\(m\)</span> candidate responses, and <span class="math notranslate nohighlight">\(P(\text{entail}|y_j, s)\)</span> denotes the NLI-estimated probability that <span class="math notranslate nohighlight">\(s\)</span> is entailed in <span class="math notranslate nohighlight">\(y_j\)</span>.</p>
<p>¬© 2025 CVS Health and/or one of its affiliates. All rights reserved.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="judges_demo.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">üéØ LLM-as-a-Judge</p>
      </div>
    </a>
    <a class="right-next"
       href="long_text_graph_demo.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">üéØ Graph-Based Uncertainty Quantification (Long-Text)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#üìä-What-You'll-Do-in-This-Demo">üìä What You‚Äôll Do in This Demo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#‚öñÔ∏è-Advantages-&amp;-Limitations">‚öñÔ∏è Advantages &amp; Limitations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#1.-Set-up-LLM-and-Prompts">1. Set up LLM and Prompts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#2.-Generate-LLM-Responses-and-Claim/Sentence-Level-Confidence-Scores">2. Generate LLM Responses and Claim/Sentence-Level Confidence Scores</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#LongTextUQ()---Generate-long-text-LLM-responses,-decompose-into-claims-or-sentences,-and-measure-entailment-among-sampled-responses."><code class="docutils literal notranslate"><span class="pre">LongTextUQ()</span></code> - Generate long-text LLM responses, decompose into claims or sentences, and measure entailment among sampled responses.</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#üìã-Class-Attributes">üìã Class Attributes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#üîç-Parameter-Groups">üîç Parameter Groups</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#üîÑ-Class-Methods">üîÑ Class Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#Response-refinement">Response refinement</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#3.-Evaluate-Hallucination-Detection-Performance">3. Evaluate Hallucination Detection Performance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#4.-Scorer-Definitions">4. Scorer Definitions</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/_notebooks/examples/long_text_uq_demo.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      ¬© Copyright 2025, CVS Health.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>